---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SITE } from '../config';

const posts = (await getCollection('backtrace')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// è¨˜äº‹ã‚’å¹´åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
const postsByYear = posts.reduce((acc, post) => {
	const year = post.data.pubDate.getFullYear();
	if (!acc[year]) {
		acc[year] = [];
	}
	acc[year].push(post);
	return acc;
}, {} as Record<number, typeof posts>);

// å¹´ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

// è¨˜äº‹ã®æŠœç²‹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆGatsbyãƒ©ã‚¤ã‚¯ç‰ˆï¼‰
function generateExcerpt(content: string): string {
	// æœ€åˆã®140æ–‡å­—ç¨‹åº¦ã‚’å–å¾—ï¼ˆGatsbyã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
	const plainText = content
		.replace(/---[\s\S]*?---/g, '') // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã‚’é™¤å»
		.slice(0, 500) // æœ€åˆã®500æ–‡å­—ã‹ã‚‰å‡¦ç†é–‹å§‹
		.replace(/```[\s\S]*?```/g, '[ã‚³ãƒ¼ãƒ‰]') // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’[ã‚³ãƒ¼ãƒ‰]ã«ç½®æ›
		.replace(/#{1,6}\s+/g, '') // ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜å·ã‚’é™¤å»
		.replace(/\*{1,2}([^*]+)\*{1,2}/g, '$1') // å¤ªå­—ãƒ»æ–œä½“è¨˜å·ã‚’é™¤å»
		.replace(/`([^`]+)`/g, '$1') // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰è¨˜å·ã‚’é™¤å»
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // ãƒªãƒ³ã‚¯è¨˜å·ã‚’é™¤å»
		.replace(/\n+/g, ' ') // æ”¹è¡Œã‚’ç©ºç™½ã«å¤‰æ›
		.replace(/\s+/g, ' ') // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
		.trim()
		.slice(0, 140); // æœ€çµ‚çš„ã«140æ–‡å­—ã«åˆ¶é™
	
	return plainText + (plainText.length >= 140 ? '...' : '');
}

// è¨˜äº‹ã®æœ¬æ–‡ã‚’èª­ã¿è¾¼ã‚“ã§æŠœç²‹ã‚’ç”Ÿæˆ
const postsWithExcerptRaw = await Promise.all(
	posts.map(async (post) => {
		const excerpt = generateExcerpt(post.body);
		return {
			...post,
			excerpt
		};
	})
);

// æŠœç²‹ç”Ÿæˆå¾Œã«å†åº¦ã‚½ãƒ¼ãƒˆ
const postsWithExcerpt = postsWithExcerptRaw.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// å¹´åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚‚æŠœç²‹ã‚’è¿½åŠ 
const postsByYearWithExcerpt = years.reduce((acc, year) => {
	acc[year] = postsByYear[year].map(post => {
		const postWithExcerpt = postsWithExcerpt.find(p => p.slug === post.slug);
		return postWithExcerpt || { ...post, excerpt: generateExcerpt(post.body) };
	});
	return acc;
}, {} as Record<number, typeof postsWithExcerpt>);
---

<Layout title={`BACKTRACE | ${SITE.title}`}>
	<!-- Tab Navigation -->
	<div class="mt-4">
		<div class="tab-container">
			<a href="/logs" class="tab">LOGS</a>
			<a href="/texts" class="tab">TEXTS</a>
			<a href="/backtrace" class="tab active">BACKTRACE</a>
		</div>
		<p class="text-sm text-gray-500 text-left pl-4 mt-2">
			<strong>[WIP]</strong> ğŸ’­ ã‹ã¤ã¦ã€Œã¯ã¦ãªã€ã§æ›¸ã„ã¦ã„ãŸã‚¢ã‚¸ãƒ£ã‚¤ãƒ«ãªé–‹ç™ºã‚’å¤¢è¦‹ã¦å¥®é—˜ã—ã¦ãŸã¨ãã®è¨˜æ†¶
		</p>
		<div class="border-t border-solid border-gray-300 mt-0 mb-2"></div>
	</div>

	<!-- View Mode Toggle -->
	<nav class="mx-auto w-5/6 mt-6 mb-4" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
		<div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 text-sm font-mono">
			<span class="whitespace-nowrap">view mode:</span>
			<div class="flex space-x-2" role="tablist" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
				<button id="flat-mode" class="view-mode-btn active px-3 py-1 rounded border" role="tab" aria-selected="true" aria-controls="flat-view">flat</button>
				<button id="yearly-mode" class="view-mode-btn px-3 py-1 rounded border" role="tab" aria-selected="false" aria-controls="yearly-view">yearly</button>
			</div>
		</div>
	</nav>

	<!-- Year Navigation (yearly mode only) -->
	<nav id="year-nav" class="mx-auto w-5/6 mb-6 hidden" aria-label="å¹´åˆ¥ã‚¸ãƒ£ãƒ³ãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
		<div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 text-sm font-mono">
			<span class="whitespace-nowrap">jump to year:</span>
			<div class="flex flex-wrap gap-2">
				{years.map(year => (
					<button 
						class="year-jump-btn px-2 py-1 rounded border hover:bg-gray-100 transition-colors"
						data-year={year}
						aria-label={`${year}å¹´ã®è¨˜äº‹ã«ã‚¸ãƒ£ãƒ³ãƒ—`}
					>
						{year}
					</button>
				))}
			</div>
		</div>
	</nav>

	<!-- Flat View (Default) -->
	<main id="flat-view" class="view-content" role="tabpanel" aria-labelledby="flat-mode">
		<ol style="list-style: none;" class="backtrace-posts">
			{postsWithExcerpt.map((post) => {
				const title = post.data.title || post.slug;
				// å¹´åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«åˆã‚ã›ãŸURLç”Ÿæˆ
				const fileName = post.slug.replace(/^\d{4}\//, ''); // å¹´åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å»
				const dateMatch = fileName.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/);
				let postUrl;
				if (dateMatch) {
					const [, year, month, day, slug] = dateMatch;
					postUrl = `/backtrace/${year}/${month}/${day}/${slug}/`;
				} else {
					postUrl = `/backtrace/${post.slug}/`;
				}
				const tags = post.data.tags || [];
				
				return (
					<li class="hover-style border-y border-solid py-2 group">
						<article
							class="mx-auto w-11/12 sm:w-5/6"
							itemscope
							itemtype="http://schema.org/Article"
						>
							<header class="py-4">
								<h2 class="text-xl sm:text-2xl font-bold font-titillium group-hover:text-green-400 transition-colors duration-200 break-words">
									<a href={postUrl} itemprop="url">
										<span itemprop="headline">{title}</span>
									</a>
								</h2>
								<time datetime={post.data.pubDate.toISOString()} itemprop="datePublished" class="text-sm text-gray-600">{post.data.pubDate.toLocaleDateString('ja-JP', {
									year: 'numeric',
									month: '2-digit',
									day: '2-digit'
								}).replace(/\//g, '/')}</time>
								{tags.length > 0 && (
									<div class="mt-2">
										{tags.map((tag: string) => (
											<span class="inline-block bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded mr-2 mb-1">
												{tag}
											</span>
										))}
									</div>
								)}
							</header>
							<section>
								<p
									itemprop="description"
									set:html={(post.data.description && post.data.description.trim() !== '') ? post.data.description : post.excerpt}
								>
								</p>
								<div class="my-2 py-2">
									<a href={postUrl} class="read-more text-base sm:text-lg font-mono text-black underline hover:text-white transition-colors duration-200 group-hover:text-green-400">&gt;&gt; READ MORE</a>
								</div>
							</section>
						</article>
					</li>
				);
			})}
		</ol>
	</main>

	<!-- Yearly View -->
	<main id="yearly-view" class="view-content hidden" role="tabpanel" aria-labelledby="yearly-mode">
		{years.map(year => {
			const yearPosts = postsByYearWithExcerpt[year];
			return (
				<section class="year-section mb-8" data-year={year} aria-labelledby={`year-${year}`}>
					<div class="flex items-center justify-between mb-4">
						<h2 id={`year-${year}`} class="text-xl sm:text-2xl font-bold font-titillium text-gray-800">{year}</h2>
						<button 
							class="back-to-top-btn px-2 py-1 text-sm font-mono border rounded hover:bg-gray-100 transition-colors"
							title="ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹"
							aria-label="å¹´åˆ¥ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹"
						>
							â†‘
						</button>
					</div>
					<div class="space-y-3 mx-auto w-11/12 sm:w-full">
						{yearPosts.map((post) => {
							const title = post.data.title || post.slug;
							const fileName = post.slug.replace(/^\d{4}\//, '');
							const dateMatch = fileName.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/);
							let postUrl;
							if (dateMatch) {
								const [, , month, day, slug] = dateMatch;
								postUrl = `/backtrace/${year}/${month}/${day}/${slug}/`;
							} else {
								postUrl = `/backtrace/${post.slug}/`;
							}
							const tags = post.data.tags || [];
							
							return (
								<article class="hover-style py-3 px-2 group border border-transparent hover:border-gray-200 rounded" itemscope itemtype="http://schema.org/Article">
									<div class="flex flex-col space-y-2">
										<div class="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-2">
											<time class="text-gray-600 whitespace-nowrap text-sm" datetime={post.data.pubDate.toISOString()} itemprop="datePublished">{post.data.pubDate.toLocaleDateString('ja-JP', {
												month: '2-digit',
												day: '2-digit'
											}).replace(/\//g, '/')}</time>
											<a href={postUrl} class="text-black group-hover:text-green-400 break-words font-mono text-sm sm:text-base transition-colors duration-200" itemprop="url headline">{title}</a>
										</div>
										{tags.length > 0 && (
											<div class="flex flex-wrap gap-1">
												{tags.map((tag: string) => (
													<span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded border">
														{tag}
													</span>
												))}
											</div>
										)}
									</div>
								</article>
							);
						})}
					</div>
				</section>
			);
		})}
	</main>
</Layout>

<style>
	/* Backtraceãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
	@media (max-width: 640px) {
		.backtrace-posts {
			padding-left: 0;
			padding-right: 0;
		}
		
		.backtrace-posts li {
			margin-left: 0.5rem;
			margin-right: 0.5rem;
		}
		
		/* å¹´åˆ¥è¡¨ç¤ºã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
		.year-section article {
			padding: 0.75rem;
		}
		
		.year-section .flex-wrap {
			gap: 0.25rem;
		}
		
		.year-section .flex-wrap span {
			font-size: 0.75rem;
			padding: 0.25rem 0.5rem;
		}
	}
	
	.view-mode-btn {
		@apply text-gray-400 border-gray-300 hover:border-gray-400 transition-colors;
	}
	.view-mode-btn.active {
		@apply text-black border-black underline;
	}
	.year-jump-btn {
		@apply text-gray-600 border-gray-300;
	}
	.year-jump-btn:hover {
		@apply text-black border-black;
	}
	.back-to-top-btn {
		@apply text-gray-600 border-gray-300;
	}
	.back-to-top-btn:hover {
		@apply text-black border-black;
	}
</style>

<script>
	// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
	function initViewModeToggle() {
		const flatBtn = document.getElementById('flat-mode');
		const yearlyBtn = document.getElementById('yearly-mode');
		const flatView = document.getElementById('flat-view');
		const yearlyView = document.getElementById('yearly-view');
		const yearNav = document.getElementById('year-nav');
		
		// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
		const savedMode = localStorage.getItem('backtrace-view-mode') || 'flat';
		
		function setViewMode(mode: string) {
			// ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
			flatBtn?.classList.toggle('active', mode === 'flat');
			yearlyBtn?.classList.toggle('active', mode === 'yearly');
			
			// ARIAå±æ€§ã‚’æ›´æ–°
			flatBtn?.setAttribute('aria-selected', (mode === 'flat').toString());
			yearlyBtn?.setAttribute('aria-selected', (mode === 'yearly').toString());
			
			// ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
			flatView?.classList.toggle('hidden', mode !== 'flat');
			yearlyView?.classList.toggle('hidden', mode !== 'yearly');
			yearNav?.classList.toggle('hidden', mode !== 'yearly');
			
			// yearlyãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã¯å¹´ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ã‚’å†åˆæœŸåŒ–
			if (mode === 'yearly') {
				// DOMã®æ›´æ–°ã‚’å¾…ã¤
				setTimeout(() => {
					initYearJump();
				}, 200);
			}
			
			// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
			localStorage.setItem('backtrace-view-mode', mode);
		}
		
		// åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
		setViewMode(savedMode);
		
		// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
		flatBtn?.addEventListener('click', () => setViewMode('flat'));
		yearlyBtn?.addEventListener('click', () => setViewMode('yearly'));
		
		// å¹´ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–
		function initYearJump() {
			const yearJumpBtns = document.querySelectorAll('.year-jump-btn');
			
			yearJumpBtns.forEach((btn) => {
				// æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
				btn.removeEventListener('click', handleYearJump);
				// æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
				btn.addEventListener('click', handleYearJump);
			});
			
			// ã€Œâ†‘ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
			const backToTopBtns = document.querySelectorAll('.back-to-top-btn');
			backToTopBtns.forEach((btn) => {
				// æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
				btn.removeEventListener('click', handleBackToTop);
				// æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
				btn.addEventListener('click', handleBackToTop);
			});
		}
		
		// å¹´ã‚¸ãƒ£ãƒ³ãƒ—ã®å‡¦ç†é–¢æ•°
		function handleYearJump(event: Event) {
			const btn = event.target as HTMLElement;
			const year = btn.getAttribute('data-year');
			
			if (year) {
				// å¹´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ­£ç¢ºã«ç‰¹å®šï¼ˆãƒœã‚¿ãƒ³ã§ã¯ãªãã€year-sectionã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ï¼‰
				const yearSection = document.querySelector(`.year-section[data-year="${year}"]`);
				
				if (yearSection) {
					yearSection.scrollIntoView({ behavior: 'smooth' });
				}
			}
		}
		
		// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹å‡¦ç†é–¢æ•°
		function handleBackToTop(event: Event) {
			const yearNav = document.getElementById('year-nav');
			if (yearNav) {
				yearNav.scrollIntoView({ behavior: 'smooth' });
			}
		}
		
		// åˆæœŸåŒ–æ™‚ã«å¹´ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ã‚’è¨­å®š
		initYearJump();
	}
	
	// DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
	document.addEventListener('DOMContentLoaded', initViewModeToggle);
</script> 