---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SITE } from '../config';

const posts = (await getCollection('backtrace')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
); // å…¨è¨˜äº‹è¡¨ç¤º

// è¨˜äº‹ã®æŠœç²‹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆGatsbyãƒ©ã‚¤ã‚¯ç‰ˆï¼‰
function generateExcerpt(content: string): string {
	// æœ€åˆã®140æ–‡å­—ç¨‹åº¦ã‚’å–å¾—ï¼ˆGatsbyã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
	const plainText = content
		.replace(/---[\s\S]*?---/g, '') // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã‚’é™¤å»
		.slice(0, 500) // æœ€åˆã®500æ–‡å­—ã‹ã‚‰å‡¦ç†é–‹å§‹
		.replace(/```[\s\S]*?```/g, '[ã‚³ãƒ¼ãƒ‰]') // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’[ã‚³ãƒ¼ãƒ‰]ã«ç½®æ›
		.replace(/#{1,6}\s+/g, '') // ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜å·ã‚’é™¤å»
		.replace(/\*{1,2}([^*]+)\*{1,2}/g, '$1') // å¤ªå­—ãƒ»æ–œä½“è¨˜å·ã‚’é™¤å»
		.replace(/`([^`]+)`/g, '$1') // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰è¨˜å·ã‚’é™¤å»
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // ãƒªãƒ³ã‚¯è¨˜å·ã‚’é™¤å»
		.replace(/\n+/g, ' ') // æ”¹è¡Œã‚’ç©ºç™½ã«å¤‰æ›
		.replace(/\s+/g, ' ') // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
		.trim()
		.slice(0, 140); // æœ€çµ‚çš„ã«140æ–‡å­—ã«åˆ¶é™
	
	return plainText + (plainText.length >= 140 ? '...' : '');
}

// è¨˜äº‹ã®æœ¬æ–‡ã‚’èª­ã¿è¾¼ã‚“ã§æŠœç²‹ã‚’ç”Ÿæˆ
const postsWithExcerptRaw = await Promise.all(
	posts.map(async (post) => {
		const excerpt = generateExcerpt(post.body);
		return {
			...post,
			excerpt
		};
	})
);

// æŠœç²‹ç”Ÿæˆå¾Œã«å†åº¦ã‚½ãƒ¼ãƒˆ
const postsWithExcerpt = postsWithExcerptRaw.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<Layout title={`BACKTRACE | ${SITE.title}`}>
	<!-- Tab Navigation -->
	<div class="mt-4">
		<div class="tab-container">
			<a href="/logs" class="tab">LOGS</a>
			<a href="/texts" class="tab">TEXTS</a>
			<a href="/backtrace" class="tab active">BACKTRACE</a>
		</div>
		<p class="text-sm text-gray-500 text-left pl-4 mt-2">
			ã¯ã¦ãªãƒ–ãƒ­ã‚°ã‹ã‚‰ç§»è¡Œã—ãŸéå»ã®è¨˜äº‹ãŸã¡ğŸ“š
		</p>
	</div>
	<ol style="list-style: none;">
		{postsWithExcerpt.map((post) => {
			const title = post.data.title || post.slug;
			// å¹´åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«åˆã‚ã›ãŸURLç”Ÿæˆ
			const fileName = post.slug.replace(/^\d{4}\//, ''); // å¹´åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å»
			const dateMatch = fileName.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/);
			let postUrl;
			if (dateMatch) {
				const [, year, month, day, slug] = dateMatch;
				postUrl = `/backtrace/${year}/${month}/${day}/${slug}/`;
			} else {
				postUrl = `/backtrace/${post.slug}/`;
			}
			const tags = post.data.tags || [];
			
			return (
				<li class="hover-style border-y border-solid py-2 group">
					<article
						class="mx-auto w-5/6"
						itemscope
						itemtype="http://schema.org/Article"
					>
						<header class="py-4">
							<h2 class="text-2xl font-bold font-titillium group-hover:text-green-400 transition-colors duration-200 break-words">
								<a href={postUrl} itemprop="url">
									<span itemprop="headline">{title}</span>
								</a>
							</h2>
							<small>{post.data.pubDate.toLocaleDateString('ja-JP', {
								year: 'numeric',
								month: '2-digit',
								day: '2-digit'
							}).replace(/\//g, '/')}</small>
							{tags.length > 0 && (
								<div class="mt-2">
									{tags.map((tag: string) => (
										<span class="inline-block bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded mr-2 mb-1">
											{tag}
										</span>
									))}
								</div>
							)}
						</header>
						<section>
							<p
								itemprop="description"
								set:html={(post.data.description && post.data.description.trim() !== '') ? post.data.description : post.excerpt}
							>
							</p>
							<div class="my-2 py-2">
								<a href={postUrl} class="read-more text-lg font-mono text-black underline hover:text-white transition-colors duration-200 group-hover:text-green-400">&gt;&gt; READ MORE</a>
							</div>
						</section>
					</article>
				</li>
			);
		})}
	</ol>
</Layout> 