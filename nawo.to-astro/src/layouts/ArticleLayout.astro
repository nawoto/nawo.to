---
import { SEO } from "astro-seo";
import Layout from './Layout.astro';
import Comments from '../components/Comments.astro';
import { SITE } from '../config';
import { getCollection } from 'astro:content';

export interface Props {
  title: string;
  content: any;
  previousPost?: any;
  nextPost?: any;
  shareUrl?: string;
}

const { title, content, previousPost, nextPost, shareUrl } = Astro.props;
const pageTitle = `${title} | ${SITE.title}`;
const authorName = SITE.author.name;
const metaDescription = content.data.description || `${title} - ${SITE.description}`;
const publishedTime = content.data.pubDate.toISOString();
const modifiedTime = content.data.updatedDate?.toISOString();
const currentUrl = shareUrl || new URL(`/${content.collection}/${content.slug}/`, SITE.url).href;
const ogImageUrl = content.data.image ? new URL(content.data.image, SITE.url).href : new URL('/images/opengraph-default.png', SITE.url).href;
---

<Layout title={pageTitle} description={metaDescription}>
  <!-- Article specific meta tags in head -->
  <Fragment slot="head">
    <meta property="article:published_time" content={publishedTime} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    <meta property="article:author" content={authorName} />
    <meta property="article:section" content="Technology" />
  </Fragment>

  <article
    itemscope
    itemtype="http://schema.org/Article"
    class="mb-16 border-t-2 border-black bg-white px-8 py-8"
  >
    <header class="mb-8">
      <h1 itemprop="headline" class="mb-4 text-3xl font-bold md:text-5xl">
        {title}
      </h1>
      <div class="mb-4 text-sm text-gray-600">
        <time itemprop="datePublished" datetime={content.data.pubDate.toISOString()}>
          {content.data.pubDate.toLocaleDateString('ja-JP')}
        </time>
        {content.data.updatedDate && (
          <>
            {' '} (更新: <time itemprop="dateModified" datetime={content.data.updatedDate.toISOString()}>
              {content.data.updatedDate.toLocaleDateString('ja-JP')}
            </time>)
          </>
        )}
      </div>
    </header>

    <div itemprop="articleBody" class="prose prose-lg max-w-none">
      <slot />
    </div>

    <footer class="mt-8 border-t pt-4">
      <div class="mb-4">
        <span class="text-sm text-gray-600">著者: </span>
        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">{authorName}</span>
        </span>
      </div>
    </footer>
  </article>

  <!-- Navigation -->
  <nav class="mb-8 flex justify-between">
    <div class="w-1/2 pr-4">
      {previousPost && (
        <a href={`/${previousPost.collection}/${previousPost.slug}/`} class="block border-2 border-black bg-white p-4 transition-colors hover:bg-gray-100">
          <div class="text-sm text-gray-600">前の記事</div>
          <div class="font-semibold">{previousPost.data.title}</div>
        </a>
      )}
    </div>
    <div class="w-1/2 pl-4">
      {nextPost && (
        <a href={`/${nextPost.collection}/${nextPost.slug}/`} class="block border-2 border-black bg-white p-4 text-right transition-colors hover:bg-gray-100">
          <div class="text-sm text-gray-600">次の記事</div>
          <div class="font-semibold">{nextPost.data.title}</div>
        </a>
      )}
    </div>
  </nav>

  <!-- Share Buttons -->
  <div class="mb-8 border-2 border-black bg-white p-6">
    <h3 class="mb-4 text-lg font-semibold">この記事をシェア</h3>
    <div class="flex flex-wrap gap-2">
      <a
        href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(currentUrl)}&text=${encodeURIComponent(title)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="share-button bg-blue-500 text-white"
      >
        Twitter
      </a>
      <a
        href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="share-button bg-blue-600 text-white"
      >
        Facebook
      </a>
      <a
        href={`https://b.hatena.ne.jp/add?mode=confirm&url=${encodeURIComponent(currentUrl)}&title=${encodeURIComponent(title)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="share-button bg-blue-700 text-white"
      >
        はてブ
      </a>
      <button
        type="button"
        class="share-button bg-gray-500 text-white"
        data-copy-url={currentUrl}
      >
        URLコピー
      </button>
    </div>
  </div>

  <!-- Comments Section -->
  <Comments />

  <script>
    // Add URL copy functionality and Instagram embed script
    document.addEventListener('DOMContentLoaded', function() {
      // URL copy functionality
      const copyButtons = document.querySelectorAll('[data-copy-url]');
      copyButtons.forEach((button) => {
        button.addEventListener('click', function(this: HTMLElement) {
          const url = this.getAttribute('data-copy-url');
          if (url && navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => {
              alert('URLをコピーしました');
            });
          }
        });
      });

      // Instagram embed script loading
      const instagramEmbeds = document.querySelectorAll('.instagram-media');
      if (instagramEmbeds.length > 0 && !document.querySelector('script[src*="instagram.com/embed.js"]')) {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = '//www.instagram.com/embed.js';
        script.async = true;
        document.head.appendChild(script);
      }
    });
  </script>

  <!-- Schema.org structured data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": metaDescription,
    "image": ogImageUrl,
    "author": {
      "@type": "Person",
      "name": authorName,
      "url": SITE.url + "/about"
    },
    "publisher": {
      "@type": "Organization",
      "name": SITE.title,
      "url": SITE.url,
      "logo": {
        "@type": "ImageObject",
        "url": SITE.url + "/images/site-icon.png"
      }
    },
    "datePublished": publishedTime,
    "dateModified": modifiedTime || publishedTime,
    "url": currentUrl,
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": currentUrl
    }
  })} />
</Layout>
