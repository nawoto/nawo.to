---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const texts = (await getCollection('texts')).sort(
	(a: CollectionEntry<'texts'>, b: CollectionEntry<'texts'>) => 
		b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// テキストの抜粋を生成する関数
function generateExcerpt(content: string, maxLength: number = 200): string {
	// マークダウンの記号を除去して、プレーンテキストに変換
	const plainText = content
		.replace(/#{1,6}\s+/g, '') // ヘッダー記号を除去
		.replace(/\*{1,2}([^*]+)\*{1,2}/g, '$1') // 太字・斜体記号を除去
		.replace(/`([^`]+)`/g, '$1') // インラインコード記号を除去
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // リンク記号を除去
		.replace(/\n{2,}/g, ' ') // 改行を空白に変換
		.trim();
	
	return plainText.length > maxLength 
		? plainText.substring(0, maxLength) + '...'
		: plainText;
}

// テキストの本文を読み込んで抜粋を生成
const textsWithExcerpt = await Promise.all(
	texts.map(async (text) => {
		const excerpt = generateExcerpt(text.body);
		return {
			...text,
			excerpt
		};
	})
);
---

<Layout title="TEXTS | #nawoto" isRootPath={false}>
	<div class="hover-style py-4 text-center">
		<h1 class="text-4xl font-semibold uppercase tracking-widest">
			texts
		</h1>
		<p class="text-sm text-gray-500">
			テキストコンテンツ
		</p>
	</div>
	<ol style="list-style: none;">
		{textsWithExcerpt.map((text) => {
			const title = text.data.title || text.slug;
			return (
				<li class="hover-style border-y border-solid py-2">
					<article
						class="mx-auto w-5/6"
						itemscope
						itemtype="http://schema.org/Article"
					>
						<header class="py-4">
							<h2 class="text-2xl font-bold">
								<a href={`/texts/${text.slug}/`} itemprop="url">
									<span itemprop="headline">{title}</span>
								</a>
							</h2>
							<small>{text.data.pubDate.toLocaleDateString('ja-JP', {
								year: 'numeric',
								month: '2-digit',
								day: '2-digit'
							}).replace(/\//g, '/')}</small>
						</header>
						<section>
							<p
								itemprop="description"
								set:html={text.data.description || text.excerpt}
							>
							</p>
							<div class="my-2 border py-2 text-center uppercase">
								<a href={`/texts/${text.slug}/`}>read more</a>
							</div>
						</section>
					</article>
				</li>
			);
		})}
	</ol>
</Layout> 